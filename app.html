<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyUpgrade Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-950">
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        window.onload = function() {
            
            const { useState, useEffect } = React;

            // --- FIX: Determine Backend URL based on Hostname ---
            // Get the current hostname where the script is running
            const currentHostname = window.location.hostname;
            const vercelHostname = 'pyupgrade-app.vercel.app'; // Replace if you use a custom domain later
            const productionBackendUrl = 'https://pyupgrade-f203f8648dc3.herokuapp.com'; // Your live Heroku URL
            const localBackendUrl = 'http://localhost:8000';

            // Check if the current hostname matches the Vercel deployment hostname
            const isProduction = currentHostname === vercelHostname;
            
            // Set BACKEND_URL accordingly
            const BACKEND_URL = isProduction ? productionBackendUrl : localBackendUrl;
            
            // Log the determined URL for debugging (you can remove this later)
            console.log("Using Backend URL:", BACKEND_URL);
            
            // --- INLINE SVG ICON COMPONENTS ---
            // (SVGs remain the same - omitted for brevity, but they are included in the full execution)
            const Icon = ({ children, className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
            const Github = ({ className }) => <Icon className={className}><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/></Icon>;
            const Lock = ({ className }) => <Icon className={className}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></Icon>;
            const ChevronRight = ({ className }) => <Icon className={className}><path d="m9 18 6-6-6-6"/></Icon>;
            const Loader2 = ({ className }) => <Icon className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></Icon>;
            const Mail = ({ className }) => <Icon className={className}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></Icon>;
            const LogOut = ({ className }) => <Icon className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></Icon>;
            const FileCode = ({ className }) => <Icon className={className}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="m10 10-2 2 2 2"/><path d="m14 14 2-2-2-2"/></Icon>;
            const ServerCrash = ({ className }) => <Icon className={className}><path d="M6 10H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-2"/><path d="M6 14H4a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2h-2"/><path d="m14 10-4 4 4 4"/><path d="m6 6 4 4-4 4"/><path d="m18 18-4-4 4-4"/></Icon>;
            const CheckCircle2 = ({ className }) => <Icon className={className}><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></Icon>;
            const AlertTriangle = ({ className }) => <Icon className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></Icon>;
            const Sparkles = ({ className }) => <Icon className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></Icon>;
            const Bot = ({ className }) => <Icon className={className}><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></Icon>;
            const GoogleGLogo = () => ( <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" className="w-5 h-5 mr-3"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/><path d="M1 1h22v22H1z" fill="none"/></svg> );

            // --- Main App Component ---
            function App() {
                // (Logic remains the same, relies on global BACKEND_URL)
                const [isLoggedIn, setIsLoggedIn] = useState(false); const [isLoading, setIsLoading] = useState(true); const [initialAction, setInitialAction] = useState('login');
                useEffect(() => { const qp = new URLSearchParams(window.location.search); if (qp.get('action') === 'signup') { setInitialAction('signup'); } const cs = async () => { try { const r = await fetch(`${BACKEND_URL}/api/me`, { credentials: 'include' }); setIsLoggedIn(r.ok); } catch (e) { setIsLoggedIn(false); } finally { setIsLoading(false); } }; cs(); }, []);
                if (isLoading) { return <div className="bg-gray-950 text-gray-200 min-h-screen flex justify-center items-center"><Loader2 className="w-16 h-16 animate-spin text-emerald-400" /></div>; }
                return <div className="bg-gray-950 text-gray-200 min-h-screen font-sans"><div className="container mx-auto px-4 h-screen">{isLoggedIn ? <MainAppView onLogout={() => setIsLoggedIn(false)} /> : <AuthView onLoginSuccess={() => setIsLoggedIn(true)} initialAction={initialAction} />}</div></div>;
            }

            // --- Auth View ---
            const AuthView = ({ onLoginSuccess, initialAction }) => {
                // (Logic remains the same, relies on global BACKEND_URL)
                const [isSignUp, setIsSignUp] = useState(initialAction === 'signup'); const [email, setEmail] = useState(''); const [password, setPassword] = useState(''); const [error, setError] = useState(''); const [isLoading, setIsLoading] = useState(false);
                const handleSubmit = async (e) => { e.preventDefault(); setError(''); setIsLoading(true); const ep = isSignUp ? '/auth/signup' : '/auth/login'; try { const r = await fetch(`${BACKEND_URL}${ep}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password, provider: 'email' }) }); const d = await r.json(); if (!r.ok) throw new Error(d.detail); if (isSignUp) { setIsSignUp(false); } else { onLoginSuccess(); } } catch (err) { setError(err.message); } finally { setIsLoading(false); } };
                return <div className="flex flex-col items-center justify-center h-full"><div className="text-center"><h1 className="text-4xl font-bold text-white"><span className="text-emerald-400">Py</span>Upgrade</h1><p className="mt-2 text-lg text-gray-400">Scan your codebase for Python version risks.</p></div><div className="mt-8 bg-gray-900/50 border border-gray-700 p-8 rounded-xl max-w-sm w-full">{isLoading ? <div className="flex justify-center items-center h-full py-28"><Loader2 className="w-10 h-10 animate-spin text-emerald-400"/></div> : <> <h2 className="text-xl font-semibold text-white text-center mb-6">{isSignUp ? 'Create an Account' : 'Sign In'}</h2><div className="space-y-3"><a href={`${BACKEND_URL}/auth/github/login`} className="w-full flex items-center justify-center bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors"><Github className="w-5 h-5 mr-3" /> Continue with GitHub</a><a href={`${BACKEND_URL}/auth/google/login`} className="w-full flex items-center justify-center bg-white hover:bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-lg transition-colors"><GoogleGLogo /> Continue with Google</a></div><div className="my-6 flex items-center"><div className="flex-grow border-t border-gray-600"></div><span className="flex-shrink mx-4 text-gray-400 text-sm">OR</span><div className="flex-grow border-t border-gray-600"></div></div><form onSubmit={handleSubmit} className="space-y-4"><div><div className="relative"><Mail className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" /><input type="email" placeholder="Email" value={email} onChange={(e) => setEmail(e.target.value)} required className="w-full bg-gray-800/50 border border-gray-600 text-white rounded-lg pl-10 pr-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-emerald-500" /></div></div><div><div className="relative"><Lock className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" /><input type="password" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} required className="w-full bg-gray-800/50 border border-gray-600 text-white rounded-lg pl-10 pr-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-emerald-500" /></div></div>{error && <p className="text-sm text-red-400">{error}</p>}<button type="submit" className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 rounded-lg transition-colors">{isSignUp ? 'Sign Up' : 'Sign In'}</button></form><p className="mt-6 text-center text-sm text-gray-400">{isSignUp ? 'Already have an account?' : "Don't have an account?"}<button onClick={() => { setIsSignUp(!isSignUp); setError(''); }} className="ml-1 font-semibold text-emerald-400 hover:text-emerald-300">{isSignUp ? 'Sign In' : 'Sign Up'}</button></p></>}</div></div>;
            };

            // --- MainAppView (The "Dashboard") ---
            const MainAppView = ({ onLogout }) => {
                 // (Logic remains the same, relies on global BACKEND_URL)
                const [appState, setAppState] = useState('repo_selection'); const [scanResult, setScanResult] = useState(null); const [repos, setRepos] = useState([]); const [isLoadingRepos, setIsLoadingRepos] = useState(true); const [error, setError] = useState(null);
                useEffect(() => { const fr = async () => { setIsLoadingRepos(true); setError(null); try { const r = await fetch(`${BACKEND_URL}/api/repositories`, { credentials: 'include' }); if (!r.ok) { const ed = await r.json(); if (r.status === 403) { throw new Error("Link GitHub account to fetch repos."); } throw new Error(ed.detail || "Failed to fetch repos."); } setRepos(await r.json()); } catch (err) { setError(err.message); } finally { setIsLoadingRepos(false); } }; fr(); }, []);
                const handleScan = async (repoFullName) => { setAppState('scanning'); setError(null); try { const sr = await fetch(`${BACKEND_URL}/api/scan`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ repo_name: repoFullName }), credentials: 'include' }); if (!sr.ok) { const ed = await sr.json(); throw new Error(ed.detail || "Failed to start scan."); } const { task_id } = await sr.json(); const pi = setInterval(async () => { try { const ssr = await fetch(`${BACKEND_URL}/api/scan/status/${task_id}`, { credentials: 'include' }); if (!ssr.ok) { clearInterval(pi); throw new Error("Failed to get scan status."); } const sd = await ssr.json(); if (sd.status === 'SUCCESS') { clearInterval(pi); setScanResult(sd.result); setAppState('report'); } else if (sd.status === 'FAILURE') { clearInterval(pi); throw new Error(sd.detail || "Scan failed."); } } catch (err) { clearInterval(pi); setError(err.message); setAppState('repo_selection'); } }, 3000); } catch (err) { setError(err.message); setAppState('repo_selection'); } };
                const handleNewScan = () => { setScanResult(null); setAppState('repo_selection'); };
                const handleGenerateFix = async (issueIndex) => { const i = scanResult.syntaxIssues[issueIndex]; const ui = [...scanResult.syntaxIssues]; ui[issueIndex] = { ...i, isLoadingSuggestion: true }; setScanResult({ ...scanResult, syntaxIssues: ui }); try { const r = await fetch(`${BACKEND_URL}/api/generate-fix`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code_snippet: i.code_snippet, issue_type: i.type, file_path: i.file, line: i.line }), credentials: 'include' }); if (!r.ok) { const ed = await r.json(); throw new Error(ed.detail || "AI suggestion failed."); } const d = await r.json(); const fi = [...scanResult.syntaxIssues]; fi[issueIndex] = { ...i, suggestion: d.suggestion, isLoadingSuggestion: false }; setScanResult({ ...scanResult, syntaxIssues: fi }); } catch (err) { const fi = [...scanResult.syntaxIssues]; fi[issueIndex] = { ...i, suggestion: `Error: ${err.message}`, isLoadingSuggestion: false }; setScanResult({ ...scanResult, syntaxIssues: fi }); } };
                const renderMainContent = () => { if (error) { return <div className="flex flex-col items-center justify-center h-full text-center"><ServerCrash className="w-12 h-12 text-red-400" /><h1 className="text-2xl font-bold text-white mt-6">An Error Occurred</h1><p className="mt-1 text-gray-400 max-w-md">{error}</p></div>; } switch (appState) { case 'repo_selection': return <RepoSelectionView repos={repos} isLoading={isLoadingRepos} onScan={handleScan} />; case 'scanning': return <ScanningView />; case 'report': return <ReportView result={scanResult} onNewScan={handleNewScan} onGenerateFix={handleGenerateFix} />; default: return <RepoSelectionView repos={repos} isLoading={isLoadingRepos} onScan={handleScan} />; } };
                return <div className="py-8 h-full flex flex-col"><header className="flex justify-between items-center flex-shrink-0"><h1 className="text-2xl font-bold text-white"><span className="text-emerald-400">Py</span>Upgrade</h1><button onClick={onLogout} className="flex items-center bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors"><LogOut className="w-4 h-4 mr-2" />Logout</button></header><main className="flex-grow mt-4 overflow-y-auto">{renderMainContent()}</main></div>;
            };

            const RepoSelectionView = ({ repos, isLoading, onScan }) => {
                 // (Logic remains the same, relies on global BACKEND_URL)
                const [selectedRepo, setSelectedRepo] = useState(null);
                useEffect(() => { if (repos && repos.length > 0 && !selectedRepo) { setSelectedRepo(repos[0].full_name); } }, [repos, selectedRepo]);
                if (isLoading) { return <div className="flex flex-col items-center justify-center h-full text-center"><Loader2 className="w-12 h-12 text-emerald-400 animate-spin" /><h1 className="text-2xl font-bold text-white mt-6">Fetching...</h1></div>; }
                if (repos.length === 0) { return <div className="flex flex-col items-center justify-center h-full text-center"><FileCode className="w-12 h-12 text-gray-500" /><h1 className="text-2xl font-bold text-white mt-6">No Python Repositories Found</h1><p className="mt-1 text-gray-400 max-w-md">No Python repositories found in your linked GitHub account.</p></div>; }
                return <div className="max-w-4xl mx-auto"> <h1 className="text-3xl font-bold text-white">Select a Repository</h1><p className="mt-2 text-gray-400">Choose a repository to scan.</p><div className="mt-8 space-y-4 max-h-[60vh] overflow-y-auto pr-2">{repos.map(repo => ( <div key={repo.id} onClick={() => setSelectedRepo(repo.full_name)} className={`bg-gray-800/50 border ${selectedRepo === repo.full_name ? 'border-emerald-500 ring-2 ring-emerald-500/30' : 'border-gray-700'} p-4 rounded-lg cursor-pointer transition-all hover:border-emerald-600`}><div className="flex items-center"><input type="radio" name="repo-selection" checked={selectedRepo === repo.full_name} readOnly className="w-4 h-4 text-emerald-600 bg-gray-700 border-gray-600"/><div className="ml-4 flex-grow"><p className="font-semibold text-white flex items-center">{repo.owner.login} / <span className="font-bold">{repo.name}</span>{repo.private && <Lock className="w-3 h-3 ml-2 text-gray-400" />}</p><p className="text-sm text-gray-400">{repo.description}</p></div></div></div>))}</div><div className="mt-8 text-right"><button onClick={() => onScan(selectedRepo)} disabled={!selectedRepo} className="bg-emerald-500 text-white font-semibold px-6 py-3 rounded-lg hover:bg-emerald-600 transition-colors disabled:bg-gray-600 flex items-center ml-auto">Scan Repository <ChevronRight className="w-5 h-5 ml-2" /></button></div></div>;
            };

            const ScanningView = () => ( <div className="flex flex-col items-center justify-center h-full text-center"><Loader2 className="w-16 h-16 text-emerald-400 animate-spin" /><h1 className="text-3xl font-bold text-white mt-8">Scanning...</h1><p className="mt-2 text-gray-400 max-w-md">Your scan has started. We'll update you when it's ready.</p></div> );

            const ReportView = ({ result, onNewScan, onGenerateFix }) => {
                 // (Logic remains the same, relies on global BACKEND_URL)
                if (!result) return <ScanningView />;
                return <div className="max-w-6xl mx-auto pb-8"><div className="flex justify-between items-start"><div><p className="text-gray-400">Scan Report for</p><h1 className="text-3xl font-bold text-white">{result.repoName}</h1></div><button onClick={onNewScan} className="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Start New Scan</button></div><div className={`mt-6 p-6 rounded-xl bg-gray-800/50 border border-gray-700`}><h3 className="font-semibold text-white flex items-center"><AlertTriangle className={`w-5 h-5 mr-2 text-red-400`}/> Executive Summary</h3><p className="text-gray-400 mt-2">{result.summary}</p></div><div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6"><div className="bg-gray-800/50 border border-gray-700 p-6 rounded-xl"><h3 className="text-lg font-semibold text-white mb-4">Problematic Dependencies ({result.dependencies.length})</h3>{result.dependencies.length > 0 ? <div className="space-y-3">{result.dependencies.map(dep => (<div key={dep.name} className={`p-4 rounded-lg border bg-red-500/20 border-red-500/30`}><div className="flex justify-between items-center"><p className={`font-bold text-red-400`}>{dep.name} <span className="text-xs font-mono text-gray-400 ml-2">{dep.version}</span></p><span className={`text-xs font-semibold px-2 py-1 rounded-full bg-red-500/20 text-red-400`}>INCOMPATIBLE</span></div><p className="text-sm text-gray-400 mt-1">{dep.reason}</p></div>))}</div> : <div className="text-center py-8 text-gray-400"><CheckCircle2 className="w-8 h-8 mx-auto mb-2"/>No problematic dependencies found.</div>}</div><div className="bg-gray-800/50 border border-gray-700 p-6 rounded-xl"><h3 className="text-lg font-semibold text-white mb-4">Syntax Issues & AI Suggestions</h3>{result.syntaxIssues.length > 0 ? <div className="space-y-4">{result.syntaxIssues.map((issue, i) => (<div key={i} className="p-4 rounded-lg bg-gray-900/70 border border-gray-700/50"><p className="font-semibold text-yellow-400">{issue.type}</p><p className="text-sm text-gray-300 font-mono">{issue.file}:{issue.line}</p>{issue.suggestion ? <div className="mt-3"><p className="text-xs text-gray-400 font-semibold">DEPRECATED:</p><pre className="bg-red-900/30 text-red-300 p-2 rounded text-xs font-mono mt-1"><code>{issue.code_snippet}</code></pre><p className="text-xs text-gray-400 font-semibold mt-2">AI SUGGESTION:</p><pre className="bg-emerald-900/30 text-emerald-300 p-2 rounded text-xs font-mono mt-1"><code>{issue.suggestion}</code></pre></div> : <div className="mt-3"><p className="text-xs text-gray-400 font-semibold">DEPRECATED:</p><pre className="bg-gray-800 p-2 rounded text-xs font-mono mt-1"><code>{issue.code_snippet}</code></pre></div>}{!issue.suggestion && <div className="mt-3 text-right"><button onClick={() => onGenerateFix(i)} disabled={issue.isLoadingSuggestion} className="inline-flex items-center text-sm bg-emerald-600/50 text-emerald-300 font-semibold py-1.5 px-3 rounded-lg hover:bg-emerald-600/70 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">{issue.isLoadingSuggestion ? <><Loader2 className="w-4 h-4 mr-2 animate-spin"/>Generating...</> : <><Bot className="w-4 h-4 mr-2" /> Generate Fix</>}</button></div>}</div>))}</div> : <div className="text-center py-8 text-gray-400"><CheckCircle2 className="w-8 h-8 mx-auto mb-2"/>No deprecated syntax found.</div>}</div></div><div className="bg-gray-800/50 border border-gray-700 p-6 rounded-xl mt-6"><h3 className="text-lg font-semibold text-white mb-4 flex items-center"><Sparkles className="w-5 h-5 mr-2 text-emerald-400" /> Recommended Migration Plan</h3><p className="text-gray-400 text-sm mb-4">AI-generated plan based on your scan results.</p><ul className="space-y-3">{result.recommendations.steps.map((step, index) => (<li key={index} className="flex items-start"><CheckCircle2 className="w-5 h-5 text-emerald-400 mt-1 flex-shrink-0" /><span className="ml-3 text-gray-300">{step}</span></li>))}</ul></div></div>;
            };

            // --- Render the Application ---
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(React.createElement(App));
        };
    </script>
</body>
</html>

